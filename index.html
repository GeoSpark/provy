<!DOCTYPE HTML>

<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <title>provy - Python provisioning made simple</title>

        <link href='http://fonts.googleapis.com/css?family=Maven+Pro|Lobster&v2' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="css/reset.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="css/main.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="css/sh_ide-anjuta.min.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="css/jquery.contextMenu.css" type="text/css" media="screen" charset="utf-8" />

        <script type="text/javascript" charset="utf-8" src="js/jquery-1.6.2.min.js"></script>

        <script type='text/javascript' src='js/jquery.contextMenu.js'></script>
        <script type='text/javascript' src='js/menu.js'></script>
    </head>

    <body>
        <ul id="context-menu" class="contextMenu">
            <li class="home">
                <a href="#top">Top</a>
            </li>
            <li class="whatsprovy separator">
                <a href="#whatsprovy">What's provy and provisioning</a>
            </li>
            <li class="installing">
                <a href="#installing">Installing provy</a>
            </li>
            <li class="getting-started">
                <a href="#getting-started">Getting Started</a>
            </li>
            <li class="templating separator">
                <a href="#templating">Custom Files and Templating</a>
            </li>
            <li class="core-and-more">
                <a href="#core-and-more">provy.core and provy.more</a>
            </li>
            <li class="roles-doc">
                <a href="#roles-doc">Roles Documentation</a>
            </li>
            <li class="contributing separator">
                <a href="#contributing">Contributing</a>
            </li>
            <li class="contacts">
                <a href="#contacts">Contacts</a>
            </li>
            <li class="license">
                <a href="#license">License</a>
            </li>
        </ul>
        <div class="container">
            <a name="top"></a>
            <div class="header">
                <h1 class="logo"><span class="important">Python</span>
                    provisioning made <span class="important">easy</span>!</h1>
                <p class="logo"><span class="important">provy</span> is an
                easy-to-use provisioning system in python.</p>
                <p class="logo">Turn that tedious task of provisioning the
                infrastructure of your website into a repeatable no-frills
                reliable process.</p>
                <div class="logo" onclick="window.location='http://provy.me';"></div>
            </div>

            <p class="disclaimer"><em>Disclaimer: all code samples in this page are
                brought to you by <a href="http://github.com/">GitHub gists</a></em></p>

            <a name="whatsprovy"></a>
            <h2 class="title">What's provy and provisioning</h2>
            <p>According to <a href="http://en.wikipedia.org/wiki/Provisioning">Wikipedia</a>, provisioning is "the
            process of preparing and equipping a network to allow it to provide
            (new) services to its users".</p>
            <p>We'll draw from this concept the part of preparing and
            equipping.</p>
            <p><em>provy</em> is a infrastructure provisioning automation tool.
            It's main goal is making it easy to create highly-scalable
            architectures with simple scripts.</p>
            <p><em>provy</em> stands on the shoulder of giants! <a
                href="http://fabfile.org" title="Fabric is a Python library and command-line tool for streamlining the use of SSH for application deployment or systems administration tasks">fabric</a> for the networking part and <a
                href="http://jinja.pocoo.org/" title="jinja2 - python templating engine">jinja2</a>
                for templating capabilities.</p>

            <p>A very simple, yet working example of a valid <em>provyfile.py</em>:</p>
            <script src="https://gist.github.com/1061912.js?file=simples-provyfile.py"></script>

            <a name="installing"></a>
            <h2 class="title">Installing provy</h2>
            <p>Before installing provy you will need to ensure you have swig
            installed, as m2crypto needs it. Here is how to install it in
            some platforms.<p>

            <p><em>MacOSX</em></p>

            <p>To install swig on a mac, the easiest way is to install using the
            <a href="http://mxcl.github.com/homebrew/">homebrew package manager</a>
            (which we will not cover here). After installing it, execute this command:
            </p>
            <script src="https://gist.github.com/1066364.js?file=install_swig_mac.sh"></script>
            <p>Just ensure that you have <em>/usr/local/bin</em> on your path.</p>

            <p><em>Arch Linux</em></p>

            <p>Swig is in the extra repository and can be installed with:<p>
            <script src="https://gist.github.com/1066392.js?file=gistfile1.bash"></script>

            <p><em>Ubuntu and Debian GNU/Linux</em></p>

            <p>It is just an apt-get install away =)<p>
            <script src="https://gist.github.com/1066406.js?file=gistfile1.txt"></script>

            <p><em>Other platforms</em></p>
            <p>If your platform is not listed above, try searching in your package
            manager for <em>swig</em> and install it given the search results.</p>

            <p><em>Install provy</em></p>

            <p>Now that you have <em>swig</em>, installing <em>provy</em> is as easy as:</p>
            <script src="https://gist.github.com/1061888.js?file=gistfile1.txt"></script>
            <p>It can be easily installed from source as well,
            like this:</p>
            <script src="https://gist.github.com/1061894.js"></script>

            <p>As can be seen above, after being installed
            a <em>provy</em> command becomes available</p>

            <p><em>provy</em> is <a
                href="http://en.wikipedia.org/wiki/Free_and_open_source_software">FOSS</a>
            and you can find it's source code at <a href="https://github.com/heynemann/provy">its github page</a>.</p>

            <a name="getting-started"></a>
            <h2 class="title">Getting started</h2>
            <p>Starting to provision servers with
            <em>provy</em> is extremely simple. We'll provision a fairly
            scalable infrastructure (yet simple) for a <a href="http://tornadoweb.org">Tornado</a> website.</p>
            <p><a href="http://tornadoweb.org">Tornado</a> is
            facebook's python web server. It features non-blocking I/O and is
            extremely fast.</p>

            <h3>The solution</h3>
            <p>Below you can see a diagram of our solution:</p>
            <img class="auto-center diagram" src="images/provy_sample.png" alt="Architecture for our
            solution" />
            <p>Our solution will feature a front-end server
            with <a href="http://www.nginx.org">one nginx instance</a> doing
            the load-balancing among the <a
                href="http://tornadoweb.org">tornado</a> instances in our back-end
            server.</p>
            <p>The back-end server will feature 4 <a href="http://tornadoweb.org">tornado</a> instances kept alive
            by <a href="http://supervisord.org/">supervisor</a> (a process monitoring tool).</p>

            <p>Create a file called <em>website.py</em> at some
            directory with this contents:</p>
            <script src="https://gist.github.com/1061912.js?file=website.py"></script>

            <p>Yes, it is not a very involved example, but
            <em>Hello World</em> suffices for our purposes. This python
            application takes a port as command-line argument and can
            be run with:</p>
            <script src="https://gist.github.com/1061912.js?file=running"></script>

            <h3>The servers</h3>
            <p>Ok, now that we have a functioning application,
            let's deploy it to production.</p>
            <p>First, let's create a local "production" environment using <a
                href="http://vagrantup.com/">Vagrant</a>. Using <a
                href="http://vagrantup.com/">Vagrant</a> is beyond the scope
            of this tutorial.</p>
            <p>First make sure you have the <em>base</em> box installed. If you
            don't, use:</p>
            <script src="https://gist.github.com/1061912.js?file=vagrant-command"></script>

            <p>In the same directory that we created the website.py
            file, type:</p>
            <script src="https://gist.github.com/1061912.js?file=vagrant-init"></script>
            <p>This will create a file called VagrantFile. This is the file
            that configures our <a href="http://vagrantup.com/">Vagrant</a>
            instances. Open it up in your editor of choice and change it to
            read:</p>
            <script src="https://gist.github.com/1061912.js?file=VagrantFile"></script>
            <p>Ok, now when we run vagrant we'll have two servers up:
            33.33.33.33 and 33.33.33.34. The first one will be our front-end
               server and the latter our back-end server.</p>

            <h3>Provisioning file</h3>
            <p>It's now time to start provisioning our servers. In the same
            directory that we created the <em>website.py</em> file, let's create a file
            called <em>provyfile.py</em>.</p>

            <p>The first thing we'll do in this file is importing the <em>provy</em>
            classes we'll use. We'll also define <em>FrontEnd</em> and
            <em>BackEnd</em> roles and assign them to our two vagrant servers.</p>
            <script src="https://gist.github.com/1061912.js?file=provyfile.py"></script>

            <p>Even though our script does not actually provision anything yet,
            let's stop to see some interesting points of it.</p>

            <p>You can see that our roles (<em>FrontEnd</em> and
            <em>BackEnd</em>) both inherit from <em>provy.Role</em>. This is
            needed so that these roles can inherit a lot of functionality
            needed for interacting with our servers.</p>

            <p>Another thing to notice is the <em>servers</em> dictionary. This
            is where we tell <em>provy</em> how to connect to each server and
            what roles does it have.</p>

            <p>We can run this script (even if it won't do anything) with:</p>
            <script src="https://gist.github.com/1061912.js?file=running-provy-file"></script>

            <h3>Provisioning the back-end server</h3>
            <p>Let's start working in our back-end server, since our front-end
            server depends on it to run.</p>
            <p>First we'll make sure we are running our app under our own user
            and not root:</p>
            <script src="https://gist.github.com/1061912.js?file=provyfile2.py"></script>

            <p>Then we'll need to copy the <em>website.py</em> file to the
            server. <em>provy</em> can easily copy files to the servers, as
            long as it can find them. Just move the <em>website.py</em> file to a directory
            named <em>files</em> in the same directory as <em>provyfile.py</em>.</p>

            <p>Now we can easily copy it to the <em>/home/frontend</em> directory:</p>
            <script src="https://gist.github.com/1061912.js?file=provyfile3.py"></script>

            <p>The <em>update_file</em> method tells provy to compare the
            source and target files and if they are different update the target
            file. For more information check the documentation.</p>

            <p>Next we must make sure <a
                href="http://tornadoweb.org">Tornado</a> is installed.
            <em>provy</em> already comes with a role that does that:</p>
            <script src="https://gist.github.com/1061953.js?file=provyfile4.py"></script>

            <p>Now all we have to do is instruct supervisor to run four
            instances of our app:</p>
            <script src="https://gist.github.com/1061953.js?file=provyfile5.py"></script>

            <h3>Provisioning the front-end server</h3>
            <p>Ok, now let's get our front-end up and running. <em>provy</em>
            comes with an <a href="http://www.nginx.org">nginx</a> module, so it is pretty easy configuring it.</p>

            <p>We have to provide template files for both <em>nginx.conf</em>
            and our website's site. Following what <a
                href="http://tornadoweb.org">Tornado</a>'s documentation
            instructs, these are good templates:</p>
            <script src="https://gist.github.com/1061953.js?file=nginx.conf"></script>
            <script src="https://gist.github.com/1061953.js?file=website"></script>

            <p>Save them as <em>files/nginx.conf</em> and
            <em>files/website</em>, respectively.</p>

            <p>Now all that's left is making sure that <em>provy</em>
            configures our front-end server:</p>
            <script src="https://gist.github.com/1061953.js?file=provyfile6.py"></script>
            <p>See how we passed the user name as an option to the
            <em>nginx.conf</em> template? <em>provy</em> allows this kind of
            template interaction in many places. For more information, check the
            documentation.</p>

            <h3>Running and verifying it works</h3>
            <p>We can now fire our brand new infrastructure and check that the
            website is working:</p>
            <script src="https://gist.github.com/1061953.js?file=running%20the%20website"></script>
            <p>After these 3 commands finished running (it might take a long
            time depending on your connection speed), you should see <em>Hello
            World</em> as the result of the curl command.</p>

            <h2 class="title">Running provy</h2>
            <p><em>provy</em> comes with a console runner. It's the same one we
            used in the <em>Getting Started</em> tutorial.</p>
            <p>The console runner supports some options. For more information
            you can use the --help command. You should see output like the
            following:</p>
            <script src="https://gist.github.com/1061953.js?file=provy-help"></script>
            <p>The option you are most likely to use is the <em>server</em>
            option. It tells <em>provy</em> what servers you want provisioned.</p>

            <h2 class="title">What are Roles?</h2>
            <p>Roles are the most important concept in <em>provy</em>. A role
            specifies one server capability, like user management or a package
            provider.</p>
            <p><em>provy</em> comes with many bundled roles, but you can very
            easily create your own roles. As a matter of fact, if you followed
            the <em>Getting Started</em> tutorial, you have already created two
            custom roles.</p>
            <p>Creating new roles is as easy as creating a class that inherits
            from <em>provy.Role</em> and implements a <em>provision</em> method.</p>
            <p>This method is the one <em>provy</em> will call when this role
            is being provisioned into a given server.</p>

            <h2 class="title">Using Roles in my Role</h2>
            <p>As you may have noticed, <em>provy</em> provides a special
            syntax for using other roles in your role. Say we need to use the
            <em>AptitudeRole</em> in our role. This is how we'd do it:</p>
            <script src="https://gist.github.com/1061953.js?file=using-roles.py"></script>
            <p>The <em>using</em> method of the Role class is a special way of
            using other roles. The reason for using it is that it maintains
            context and the <em>provy</em> lifecycle (more on both later).</p>
            <p>If you just want to provision another role in your role, you can
            use:</p>
            <script src="https://gist.github.com/1061953.js?file=using-roles-2.py"></script>
            <p>The <em>provision_role</em> method does exactly the same as the
            <em>using</em> method, except it does not enter a with block. This
            should be used when you don't wnat to call anything in the role,
            instead just have it provisioned.</p>

            <a name="templating"></a>
            <h2 class="title">Custom Files and Templating</h2>
            <p>Some methods provided by provy (including <em>update_file</em>) support 
            passing in options that may be used in templates.</p>
            <p><em>provy</em> uses <a
                href="http://jinja.pocoo.org/" title="jinja2 - python templating engine">jinja2</a> for
                templating, thus supporting if/else statements, loops and much more. It's advised
                that you take a look at <a
                href="http://jinja.pocoo.org/" title="jinja2 - python templating engine">jinja2</a>
                docs.
            </p>
            <p><a
                href="http://jinja.pocoo.org/" title="jinja2 - python templating engine">jinja2</a> will
                look for files in two different places. The first one and probably the one you'll use the most,
                is a directory called <em>files</em> in the same path as <em>provyfile.py</em>.</p>
            <p>Any files you place inside this directory may be used as templates to be uploaded to the server
            being provisioned. Since <em>provy</em> is built on top of <a
                href="http://fabfile.org" title="Fabric is a Python library and command-line tool for streamlining the use of SSH for application deployment or systems administration tasks">fabric</a>, you can use it's <em>put</em> method as well to put any file or folder to the server. It's advised to use the bundled methods that come with provy, though, as those are <a href="http://en.wikipedia.org/wiki/Idempotence">idempotent</a>.</p>
            <p>The other place you can put files is in a <em>templates</em> directory inside Role apps. The supervisor role uses this approach, if you want to take a look at an example. If you do place files in the <em>templates</em> directory, do not forget to call the <em>register_template_loader</em> method passing in the full namespace of your app (more details in the provy.more section below).</p>
            <p>We used custom files in the <em>Getting Started</em> section to provide the needed configuration files for <a href="http://www.nginx.org">nginx</a>.</p>
            <a name="core-and-more"></a>
            <h2 class="title">provy.core and provy.more</h2>
            <p>
                <em>provy</em> is divided in two namespaces: <em>provy.core</em> and <em>provy.more</em>. It is divided like this to make it easier to find the roles you need.
            </p>
            <p><em>provy.core</em> features the code that actually makes <em>provy</em> run, like the console app or the base Role.</p>
            <p><em>provy.more</em> features every single specialized role that helps users in provisioning servers, like <em>NginxRole</em> or <em>AptitudeRole</em>.</p>
            <p>Both will be documented here, even though you are advised to take a look at the code, since the docs might not be up-to-date yet.</p>

            <a name="roles-doc"></a>
            <h2 class="title">Roles Documentation</h2>
            <p>Click on the role/module you want help with.</p>
            <div id="docs-container">
                <div id="docs"></div>
            </div>
            <div id="current-doc"></div>
            <div id="module-template">
                <h3 class="name"></h3>
                <p class="docs"></p>
            </div>
            <div id="role-template">
                <h3 class="name"></h3>
                <p class="docs"></p>
                <p class="methods-header"><strong>Methods:</strong></p>
                <div class="methods"></div>
            </div>
            <div id="method-template">
                <p><em class="name"></em></p>
                <p class="docs"></p>
            </div>

            <a name="contributing"></a>
            <h2 class="title">Contributing</h2>
            <p>Contributions are very welcome. Specially roles. If you
            implement a role that you think others might be using, please
            contribute.</p>
            <p>To contribute head to <a
            href="https://github.com/heynemann/provy">provy's github page</a>,
            fork it and create a pull request.</p>
            <p>Contributors will get listed here for their contributions.</p>

            <p>The team behind provy (in order of joining the project):</p>
            <p> » <a href="http://about.me/heynemann">Bernardo Heynemann</a></p>
            <p> » <a href="http://about.me/rafaelcaricio">Rafael Carício</a></p>
            <p> » <a href="https://github.com/dsarch">Douglas Andrade</a></p>
            <p> » <a href="http://avelino.us/">Thiago Avelino</a></p>

            <a name="contacts"></a>
            <h2 class="title">Contacts</h2>
            <p>The place to create issues is <a href="">provy's github issues</a>. The more information you send about an issue, the greater the chance it will get fixed fast.</p>
            <p>If you are not sure about something, have a doubt or feedback, or just want to ask for a feature, feel free to join our mailing list using the form below.</p>
            <form action="http://groups.google.com/group/provy/boxsubscribe">
                <p>
                    <label for"email">Email: <input type="text" name="email" size="40">
                    <input type=submit class="email" name="sub" value="Subscribe">
                    <img src="http://groups.google.com/intl/en/images/logos/groups_logo_sm.gif"
                             height=30 width=140 valign="middle" alt="Google Groups" class="google-logo">
                </p>
            </form>
            <p>
              <a href="http://groups.google.com/group/provy">Visit provy's group</a>
            </p>

            <a name="license"></a>
            <h2 class="title">License</h2>
            <p><em>provy</em> is licensed under the <a
                href="http://www.opensource.org/licenses/MIT">MIT License</a></p>
            <pre class="license">
Copyright (c) 2011 Bernardo Heynemann

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to use,
copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the
Software, and to permit persons to whom the Software is furnished to do so,
subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
            </pre>

            <div class="footer">
                provy is free open source software - 2011
            </div>
        </div>

        <script type="text/javascript" src="js/sh_main.min.js"></script>
        <script type="text/javascript" src="js/sh_python.min.js"></script>

        <script type='text/javascript' src='https://www.google.com/jsapi'></script>
        <script type='text/javascript' src='js/chart.js'></script>

        <script type="text/javascript">

          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-24327816-1']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();

        </script>
    </body>

</html>
